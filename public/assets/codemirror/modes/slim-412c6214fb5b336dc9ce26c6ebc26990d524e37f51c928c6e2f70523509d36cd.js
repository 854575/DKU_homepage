!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("slim",function(t){function n(e,t,n){var i=function(i,r){return r.tokenize=t,i.pos<e?(i.pos=e,n):r.tokenize(i,r)};return function(e,n){return n.tokenize=i,t(e,n)}}function i(e,t,i,r,o){var a=e.current(),s=a.search(i);return s>-1&&(t.tokenize=n(e.pos,t.tokenize,o),e.backUp(a.length-s-r)),o}function r(e,t){e.stack={parent:e.stack,style:"continuation",indented:t,tokenize:e.line},e.line=e.tokenize}function o(e){e.line==e.tokenize&&(e.line=e.stack.tokenize,e.stack=e.stack.parent)}function a(e,t){return function(n,i){if(o(i),n.match(/^\\$/))return r(i,e),"lineContinuation";var a=t(n,i);return n.eol()&&n.current().match(/(?:^|[^\\])(?:\\\\)*\\$/)&&n.backUp(1),a}}function s(e,t){return function(n,i){o(i);var a=t(n,i);return n.eol()&&n.current().match(/,$/)&&r(i,e),a}}function l(e,t){return function(n,i){var r=n.peek();return r==e&&1==i.rubyState.tokenize.length?(n.next(),i.tokenize=t,"closeAttributeTag"):u(n,i)}}function c(t){var n,i=function(e,i){if(1==i.rubyState.tokenize.length&&!i.rubyState.context.prev){if(e.backUp(1),e.eatSpace())return i.rubyState=n,i.tokenize=t,t(e,i);e.next()}return u(e,i)};return function(t,r){return n=r.rubyState,r.rubyState=e.startState(P),r.tokenize=i,u(t,r)}}function u(e,t){return P.token(e,t.rubyState)}function d(e,t){return e.match(/^\\$/)?"lineContinuation":f(e,t)}function f(e,t){return e.match(/^#\{/)?(t.tokenize=l("}",t.tokenize),null):i(e,t,/[^\\]#\{/,1,q.token(e,t.htmlState))}function h(e){return function(t,n){var i=d(t,n);return t.eol()&&(n.tokenize=e),i}}function p(e,t,n){return t.stack={parent:t.stack,style:"html",indented:e.column()+n,tokenize:t.line},t.line=t.tokenize=f,null}function m(e,t){return e.skipToEnd(),t.stack.style}function g(e,t){return t.stack={parent:t.stack,style:"comment",indented:t.indented+1,tokenize:t.line},t.line=m,m(e,t)}function v(e,t){return e.eat(t.stack.endQuote)?(t.line=t.stack.line,t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,null):e.match(X)?(t.tokenize=y,"slimAttribute"):(e.next(),null)}function y(e,t){return e.match(/^==?/)?(t.tokenize=b,null):v(e,t)}function b(e,t){var n=e.peek();return'"'==n||"'"==n?(t.tokenize=j(n,"string",!0,!1,v),e.next(),t.tokenize(e,t)):"["==n?c(v)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=v,"keyword"):c(v)(e,t)}function _(e,t,n){return e.stack={parent:e.stack,style:"wrapper",indented:e.indented+1,tokenize:n,line:e.line,endQuote:t},e.line=e.tokenize=v,null}function x(t,n){if(t.match(/^#\{/))return n.tokenize=l("}",n.tokenize),null;var i=new e.StringStream(t.string.slice(n.stack.indented),t.tabSize);i.pos=t.pos-n.stack.indented,i.start=t.start-n.stack.indented,i.lastColumnPos=t.lastColumnPos-n.stack.indented,i.lastColumnValue=t.lastColumnValue-n.stack.indented;var r=n.subMode.token(i,n.subState);return t.pos=i.pos+n.stack.indented,r}function k(e,t){return t.stack.indented=e.column(),t.line=t.tokenize=x,t.tokenize(e,t)}function w(n){var i=F[n],r=e.mimeModes[i];if(r)return e.getMode(t,r);var o=e.modes[i];return o?o(t,{name:i}):e.getMode(t,"null")}function C(e){return z.hasOwnProperty(e)?z[e]:z[e]=w(e)}function S(t,n){var i=C(t),r=e.startState(i);return n.subMode=i,n.subState=r,n.stack={parent:n.stack,style:"sub",indented:n.indented+1,tokenize:n.line},n.line=n.tokenize=k,"slimSubmode"}function T(e){return e.skipToEnd(),"slimDoctype"}function E(e,t){var n=e.peek();if("<"==n)return(t.tokenize=h(t.tokenize))(e,t);if(e.match(/^[|']/))return p(e,t,1);if(e.match(/^\/(!|\[\w+])?/))return g(e,t);if(e.match(/^(-|==?[<>]?)/))return t.tokenize=a(e.column(),s(e.column(),u)),"slimSwitch";if(e.match(/^doctype\b/))return t.tokenize=T,"keyword";var i=e.match(H);return i?S(i[1],t):M(e,t)}function A(e,t){return t.startOfLine?E(e,t):M(e,t)}function M(e,t){return e.eat("*")?(t.tokenize=c(L),null):e.match(G)?(t.tokenize=L,"slimTag"):N(e,t)}function L(e,t){return e.match(/^(<>?|><?)/)?(t.tokenize=N,null):N(e,t)}function N(e,t){return e.match(Z)?(t.tokenize=N,"slimId"):e.match(Y)?(t.tokenize=N,"slimClass"):I(e,t)}function I(e,t){return e.match(/^([\[\{\(])/)?_(t,B[RegExp.$1],I):e.match(K)?(t.tokenize=D,"slimAttribute"):"*"==e.peek()?(e.next(),t.tokenize=c($),null):$(e,t)}function D(e,t){return e.match(/^==?/)?(t.tokenize=O,null):I(e,t)}function O(e,t){var n=e.peek();return'"'==n||"'"==n?(t.tokenize=j(n,"string",!0,!1,I),e.next(),t.tokenize(e,t)):"["==n?c(I)(e,t):":"==n?c(R)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=I,"keyword"):c(I)(e,t)}function R(e,t){return e.backUp(1),e.match(/^[^\s],(?=:)/)?(t.tokenize=c(R),null):(e.next(),I(e,t))}function j(e,t,n,i,a){return function(s,c){o(c);var u=0==s.current().length;if(s.match(/^\\$/,u))return u?(r(c,c.indented),"lineContinuation"):t;if(s.match(/^#\{/,u))return u?(c.tokenize=l("}",c.tokenize),null):t;for(var d,f=!1;null!=(d=s.next());){if(d==e&&(i||!f)){c.tokenize=a;break}if(n&&"#"==d&&!f&&s.eat("{")){s.backUp(2);break}f=!f&&"\\"==d}return s.eol()&&f&&s.backUp(1),t}}function $(e,t){return e.match(/^==?/)?(t.tokenize=u,"slimSwitch"):e.match(/^\/$/)?(t.tokenize=A,null):e.match(/^:/)?(t.tokenize=M,"slimSwitch"):(p(e,t,0),t.tokenize(e,t))}var q=e.getMode(t,{name:"htmlmixed"}),P=e.getMode(t,"ruby"),z={html:q,ruby:P},F={ruby:"ruby",javascript:"javascript",css:"text/css",sass:"text/x-sass",scss:"text/x-scss",less:"text/x-less",styl:"text/x-styl",coffee:"coffeescript",asciidoc:"text/x-asciidoc",markdown:"text/x-markdown",textile:"text/x-textile",creole:"text/x-creole",wiki:"text/x-wiki",mediawiki:"text/x-mediawiki",rdoc:"text/x-rdoc",builder:"text/x-builder",nokogiri:"text/x-nokogiri",erb:"application/x-erb"},H=function(e){var t=[];for(var n in e)t.push(n);return new RegExp("^("+t.join("|")+"):")}(F),W={commentLine:"comment",slimSwitch:"operator special",slimTag:"tag",slimId:"attribute def",slimClass:"attribute qualifier",slimAttribute:"attribute",slimSubmode:"keyword special",closeAttributeTag:null,slimDoctype:null,lineContinuation:null},B={"{":"}","[":"]","(":")"},U="_a-zA-Z\xc0-\xd6\xd8-\xf6\xf8-\u02ff\u0370-\u037d\u037f-\u1fff\u200c-\u200d\u2070-\u218f\u2c00-\u2fef\u3001-\ud7ff\uf900-\ufdcf\ufdf0-\ufffd",V=U+"\\-0-9\xb7\u0300-\u036f\u203f-\u2040",G=new RegExp("^[:"+U+"](?::["+V+"]|["+V+"]*)"),K=new RegExp("^[:"+U+"][:\\."+V+"]*(?=\\s*=)"),X=new RegExp("^[:"+U+"][:\\."+V+"]*"),Y=/^\.-?[_a-zA-Z]+[\w\-]*/,Z=/^#[_a-zA-Z]+[\w\-]*/,Q={startState:function(){var t=e.startState(q),n=e.startState(P);return{htmlState:t,rubyState:n,stack:null,last:null,tokenize:A,line:A,indented:0}},copyState:function(t){return{htmlState:e.copyState(q,t.htmlState),rubyState:e.copyState(P,t.rubyState),subMode:t.subMode,subState:t.subMode&&e.copyState(t.subMode,t.subState),stack:t.stack,last:t.last,tokenize:t.tokenize,line:t.line}},token:function(e,t){if(e.sol())for(t.indented=e.indentation(),t.startOfLine=!0,t.tokenize=t.line;t.stack&&t.stack.indented>t.indented&&"slimSubmode"!=t.last;)t.line=t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,t.subMode=null,t.subState=null;if(e.eatSpace())return null;var n=t.tokenize(e,t);return t.startOfLine=!1,n&&(t.last=n),W.hasOwnProperty(n)?W[n]:n},blankLine:function(e){if(e.subMode&&e.subMode.blankLine)return e.subMode.blankLine(e.subState)},innerMode:function(e){return e.subMode?{state:e.subState,mode:e.subMode}:{state:e,mode:Q}}};return Q},"htmlmixed","ruby"),e.defineMIME("text/x-slim","slim"),e.defineMIME("application/x-slim","slim")});