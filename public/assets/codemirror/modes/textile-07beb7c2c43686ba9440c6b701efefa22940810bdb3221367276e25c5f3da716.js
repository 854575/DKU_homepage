!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t){t.mode=f.newLayout,t.tableHeading=!1,"definitionList"===t.layoutType&&t.spanningLayout&&e.match(c("definitionListEnd"),!1)&&(t.spanningLayout=!1)}function n(e,t,n){if("_"===n)return e.eat("_")?i(e,t,"italic",/__/,2):i(e,t,"em",/_/,1);if("*"===n)return e.eat("*")?i(e,t,"bold",/\*\*/,2):i(e,t,"strong",/\*/,1);if("["===n)return e.match(/\d+\]/)&&(t.footCite=!0),r(t);if("("===n){var o=e.match(/^(r|tm|c)\)/);if(o)return a(t,u.specialChar)}if("<"===n&&e.match(/(\w+)[^>]+>[^<]+<\/\1>/))return a(t,u.html);if("?"===n&&e.eat("?"))return i(e,t,"cite",/\?\?/,2);if("="===n&&e.eat("="))return i(e,t,"notextile",/==/,2);if("-"===n&&!e.eat("-"))return i(e,t,"deletion",/-/,1);if("+"===n)return i(e,t,"addition",/\+/,1);if("~"===n)return i(e,t,"sub",/~/,1);if("^"===n)return i(e,t,"sup",/\^/,1);if("%"===n)return i(e,t,"span",/%/,1);if("@"===n)return i(e,t,"code",/@/,1);if("!"===n){var s=i(e,t,"image",/(?:\([^\)]+\))?!/,1);return e.match(/^:\S+/),s}return r(t)}function i(e,t,n,i,o){var a=e.pos>o?e.string.charAt(e.pos-o-1):null,s=e.peek();if(t[n]){if((!s||/\W/.test(s))&&a&&/\S/.test(a)){var l=r(t);return t[n]=!1,l}}else(!a||/\W/.test(a))&&s&&/\S/.test(s)&&e.match(new RegExp("^.*\\S"+i.source+"(?:\\W|$)"),!1)&&(t[n]=!0,t.mode=f.attributes);return r(t)}function r(e){var t=o(e);if(t)return t;var n=[];return e.layoutType&&n.push(u[e.layoutType]),n=n.concat(s(e,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading")),"header"===e.layoutType&&n.push(u.header+"-"+e.header),n.length?n.join(" "):null}function o(e){var t=e.layoutType;switch(t){case"notextile":case"code":case"pre":return u[t];default:return e.notextile?u.notextile+(t?" "+u[t]:""):null}}function a(e,t){var n=o(e);if(n)return n;var i=r(e);return t?i?i+" "+t:t:i}function s(e){for(var t=[],n=1;n<arguments.length;++n)e[arguments[n]]&&t.push(u[arguments[n]]);return t}function l(e){var t=e.spanningLayout,n=e.layoutType;for(var i in e)e.hasOwnProperty(i)&&delete e[i];e.mode=f.newLayout,t&&(e.layoutType=n,e.spanningLayout=!0)}function c(e){return d.cache[e]||(d.cache[e]=d.createRe(e))}var u={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"},d={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(e){switch(e){case"drawTable":return d.makeRe("^",d.single.drawTable,"$");case"html":return d.makeRe("^",d.single.html,"(?:",d.single.html,")*","$");case"linkDefinition":return d.makeRe("^",d.single.linkDefinition,"$");case"listLayout":return d.makeRe("^",d.single.list,c("allAttributes"),"*\\s+");case"tableCellAttributes":return d.makeRe("^",d.choiceRe(d.single.tableCellAttributes,c("allAttributes")),"+\\.");case"type":return d.makeRe("^",c("allTypes"));case"typeLayout":return d.makeRe("^",c("allTypes"),c("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return d.makeRe("^",c("allAttributes"),"+");case"allTypes":return d.choiceRe(d.single.div,d.single.foot,d.single.header,d.single.bc,d.single.bq,d.single.notextile,d.single.pre,d.single.table,d.single.para);case"allAttributes":return d.choiceRe(d.attributes.selector,d.attributes.css,d.attributes.lang,d.attributes.align,d.attributes.pad);default:return d.makeRe("^",d.single[e])}},makeRe:function(){for(var e="",t=0;t<arguments.length;++t){var n=arguments[t];e+="string"==typeof n?n:n.source}return new RegExp(e)},choiceRe:function(){for(var e=[arguments[0]],t=1;t<arguments.length;++t)e[2*t-1]="|",e[2*t]=arguments[t];return e.unshift("(?:"),e.push(")"),d.makeRe.apply(null,e)}},f={newLayout:function(e,t){if(e.match(c("typeLayout"),!1))return t.spanningLayout=!1,(t.mode=f.blockType)(e,t);var n;return o(t)||(e.match(c("listLayout"),!1)?n=f.list:e.match(c("drawTable"),!1)?n=f.table:e.match(c("linkDefinition"),!1)?n=f.linkDefinition:e.match(c("definitionList"))?n=f.definitionList:e.match(c("html"),!1)&&(n=f.html)),(t.mode=n||f.text)(e,t)},blockType:function(e,t){var n,i;return t.layoutType=null,(n=e.match(c("type")))?(i=n[0],(n=i.match(c("header")))?(t.layoutType="header",t.header=parseInt(n[0][1])):i.match(c("bq"))?t.layoutType="quote":i.match(c("bc"))?t.layoutType="code":i.match(c("foot"))?t.layoutType="footnote":i.match(c("notextile"))?t.layoutType="notextile":i.match(c("pre"))?t.layoutType="pre":i.match(c("div"))?t.layoutType="div":i.match(c("table"))&&(t.layoutType="table"),t.mode=f.attributes,r(t)):(t.mode=f.text)(e,t)},text:function(e,t){if(e.match(c("text")))return r(t);var i=e.next();return'"'===i?(t.mode=f.link)(e,t):n(e,t,i)},attributes:function(e,t){return t.mode=f.layoutLength,e.match(c("attributes"))?a(t,u.attributes):r(t)},layoutLength:function(e,t){return e.eat(".")&&e.eat(".")&&(t.spanningLayout=!0),t.mode=f.text,r(t)},list:function(e,t){var n=e.match(c("list"));t.listDepth=n[0].length;var i=(t.listDepth-1)%3;return i?1===i?t.layoutType="list2":t.layoutType="list3":t.layoutType="list1",t.mode=f.attributes,r(t)},link:function(e,t){return t.mode=f.text,e.match(c("link"))?(e.match(/\S+/),a(t,u.link)):r(t)},linkDefinition:function(e,t){return e.skipToEnd(),a(t,u.linkDefinition)},definitionList:function(e,t){return e.match(c("definitionList")),t.layoutType="definitionList",e.match(/\s*$/)?t.spanningLayout=!0:t.mode=f.attributes,r(t)},html:function(e,t){return e.skipToEnd(),a(t,u.html)},table:function(e,t){return t.layoutType="table",(t.mode=f.tableCell)(e,t)},tableCell:function(e,t){return e.match(c("tableHeading"))?t.tableHeading=!0:e.eat("|"),t.mode=f.tableCellAttributes,r(t)},tableCellAttributes:function(e,t){return t.mode=f.tableText,e.match(c("tableCellAttributes"))?a(t,u.attributes):r(t)},tableText:function(e,t){return e.match(c("tableText"))?r(t):"|"===e.peek()?(t.mode=f.tableCell,r(t)):n(e,t,e.next())}};e.defineMode("textile",function(){return{startState:function(){return{mode:f.newLayout}},token:function(e,n){return e.sol()&&t(e,n),n.mode(e,n)},blankLine:l}}),e.defineMIME("text/x-textile","textile")});