!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],t):t(CodeMirror)}(function(t){"use strict";t.defineMode("haml",function(e){function n(t){return function(e,n){var o=e.peek();return o==t&&1==n.rubyState.tokenize.length?(e.next(),n.tokenize=r,"closeAttributeTag"):i(e,n)}}function i(t,e){return t.match("-#")?(t.skipToEnd(),"comment"):a.token(t,e.rubyState)}function r(t,e){var r=t.peek();if("comment"==e.previousToken.style&&e.indented>e.previousToken.indented)return t.skipToEnd(),"commentLine";if(e.startOfLine){if("!"==r&&t.match("!!"))return t.skipToEnd(),"tag";if(t.match(/^%[\w:#\.]+=/))return e.tokenize=i,"hamlTag";if(t.match(/^%[\w:]+/))return"hamlTag";if("/"==r)return t.skipToEnd(),"comment"}if((e.startOfLine||"hamlTag"==e.previousToken.style)&&("#"==r||"."==r))return t.match(/[\w-#\.]*/),"hamlAttribute";if(e.startOfLine&&!t.match("-->",!1)&&("="==r||"-"==r))return e.tokenize=i,e.tokenize(t,e);if("hamlTag"==e.previousToken.style||"closeAttributeTag"==e.previousToken.style||"hamlAttribute"==e.previousToken.style){if("("==r)return e.tokenize=n(")"),e.tokenize(t,e);if("{"==r&&!t.match(/^\{%.*/))return e.tokenize=n("}"),e.tokenize(t,e)}return o.token(t,e.htmlState)}var o=t.getMode(e,{name:"htmlmixed"}),a=t.getMode(e,"ruby");return{startState:function(){var e=t.startState(o),n=t.startState(a);return{htmlState:e,rubyState:n,indented:0,previousToken:{style:null,indented:0},tokenize:r}},copyState:function(e){return{htmlState:t.copyState(o,e.htmlState),rubyState:t.copyState(a,e.rubyState),indented:e.indented,previousToken:e.previousToken,tokenize:e.tokenize}},token:function(t,e){if(t.sol()&&(e.indented=t.indentation(),e.startOfLine=!0),t.eatSpace())return null;var n=e.tokenize(t,e);if(e.startOfLine=!1,n&&"commentLine"!=n&&(e.previousToken={style:n,indented:e.indented}),t.eol()&&e.tokenize==i){t.backUp(1);var o=t.peek();t.next(),o&&","!=o&&(e.tokenize=r)}return"hamlTag"==n?n="tag":"commentLine"==n?n="comment":"hamlAttribute"==n?n="attribute":"closeAttributeTag"==n&&(n=null),n}}},"htmlmixed","ruby"),t.defineMIME("text/x-haml","haml")});