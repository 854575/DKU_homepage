!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],t):t(CodeMirror)}(function(t){"use strict";function e(e,n,i){if(i<0&&0==n.ch)return e.clipPos(h(n.line-1));var r=e.getLine(n.line);if(i>0&&n.ch>=r.length)return e.clipPos(h(n.line+1,0));for(var o,s="start",a=n.ch,l=i<0?0:r.length,c=0;a!=l;a+=i,c++){var u=r.charAt(i<0?a-1:a),d="_"!=u&&t.isWordChar(u)?"w":"o";if("w"==d&&u.toUpperCase()==u&&(d="W"),"start"==s)"o"!=d&&(s="in",o=d);else if("in"==s&&o!=d){if("w"==o&&"W"==d&&i<0&&a--,"W"==o&&"w"==d&&i>0){o="w";continue}break}}return h(n.line,a)}function n(t,n){t.extendSelectionsBy(function(i){return t.display.shift||t.doc.extend||i.empty()?e(t.doc,i.head,n):n<0?i.from():i.to()})}function i(e,n){return e.isReadOnly()?t.Pass:(e.operation(function(){for(var t=e.listSelections().length,i=[],r=-1,o=0;o<t;o++){var s=e.listSelections()[o].head;if(!(s.line<=r)){var a=h(s.line+(n?0:1),0);e.replaceRange("\n",a,null,"+insertLine"),e.indentLine(a.line,null,!0),i.push({head:a,anchor:a}),r=s.line+1}}e.setSelections(i)}),void e.execCommand("indentAuto"))}function r(e,n){for(var i=n.ch,r=i,o=e.getLine(n.line);i&&t.isWordChar(o.charAt(i-1));)--i;for(;r<o.length&&t.isWordChar(o.charAt(r));)++r;return{from:h(n.line,i),to:h(n.line,r),word:o.slice(i,r)}}function o(t){var e=t.getCursor(),n=t.scanForBracket(e,-1);if(n)for(;;){var i=t.scanForBracket(e,1);if(!i)return;if(i.ch==m.charAt(m.indexOf(n.ch)+1))return t.setSelection(h(n.pos.line,n.pos.ch+1),i.pos,!1),!0;e=h(i.pos.line,i.pos.ch+1)}}function s(e,n){if(e.isReadOnly())return t.Pass;for(var i,r=e.listSelections(),o=[],s=0;s<r.length;s++){var a=r[s];if(!a.empty()){for(var l=a.from().line,c=a.to().line;s<r.length-1&&r[s+1].from().line==c;)c=a[++s].to().line;o.push(l,c)}}o.length?i=!0:o.push(e.firstLine(),e.lastLine()),e.operation(function(){for(var t=[],r=0;r<o.length;r+=2){var s=o[r],a=o[r+1],l=h(s,0),c=h(a),u=e.getRange(l,c,!1);n?u.sort():u.sort(function(t,e){var n=t.toUpperCase(),i=e.toUpperCase();return n!=i&&(t=n,e=i),t<e?-1:t==e?0:1}),e.replaceRange(u,l,c),i&&t.push({anchor:l,head:c})}i&&e.setSelections(t,0)})}function a(e,n){e.operation(function(){for(var i=e.listSelections(),o=[],s=[],a=0;a<i.length;a++){var l=i[a];l.empty()?(o.push(a),s.push("")):s.push(n(e.getRange(l.from(),l.to())))}e.replaceSelections(s,"around","case");for(var c,a=o.length-1;a>=0;a--){var l=i[o[a]];if(!(c&&t.cmpPos(l.head,c)>0)){var u=r(e,l.head);c=u.from,e.replaceRange(n(u.word),u.from,u.to)}}})}function l(e){var n=e.getCursor("from"),i=e.getCursor("to");if(0==t.cmpPos(n,i)){var o=r(e,n);if(!o.word)return;n=o.from,i=o.to}return{from:n,to:i,query:e.getRange(n,i),word:o}}function c(t,e){var n=l(t);if(n){var i=n.query,r=t.getSearchCursor(i,e?n.to:n.from);(e?r.findNext():r.findPrevious())?t.setSelection(r.from(),r.to()):(r=t.getSearchCursor(i,e?h(t.firstLine(),0):t.clipPos(h(t.lastLine()))),(e?r.findNext():r.findPrevious())?t.setSelection(r.from(),r.to()):n.word&&t.setSelection(n.from,n.to))}}var u=t.keyMap.sublime={fallthrough:"default"},d=t.commands,h=t.Pos,f=t.keyMap["default"]==t.keyMap.macDefault,p=f?"Cmd-":"Ctrl-";d[u["Alt-Left"]="goSubwordLeft"]=function(t){n(t,-1)},d[u["Alt-Right"]="goSubwordRight"]=function(t){n(t,1)},f&&(u["Cmd-Left"]="goLineStartSmart");var g=f?"Ctrl-Alt-":"Ctrl-";d[u[g+"Up"]="scrollLineUp"]=function(t){var e=t.getScrollInfo();if(!t.somethingSelected()){var n=t.lineAtHeight(e.top+e.clientHeight,"local");t.getCursor().line>=n&&t.execCommand("goLineUp")}t.scrollTo(null,e.top-t.defaultTextHeight())},d[u[g+"Down"]="scrollLineDown"]=function(t){var e=t.getScrollInfo();if(!t.somethingSelected()){var n=t.lineAtHeight(e.top,"local")+1;t.getCursor().line<=n&&t.execCommand("goLineDown")}t.scrollTo(null,e.top+t.defaultTextHeight())},d[u["Shift-"+p+"L"]="splitSelectionByLine"]=function(t){for(var e=t.listSelections(),n=[],i=0;i<e.length;i++)for(var r=e[i].from(),o=e[i].to(),s=r.line;s<=o.line;++s)o.line>r.line&&s==o.line&&0==o.ch||n.push({anchor:s==r.line?r:h(s,0),head:s==o.line?o:h(s)});t.setSelections(n,0)},u["Shift-Tab"]="indentLess",d[u.Esc="singleSelectionTop"]=function(t){var e=t.listSelections()[0];t.setSelection(e.anchor,e.head,{scroll:!1})},d[u[p+"L"]="selectLine"]=function(t){for(var e=t.listSelections(),n=[],i=0;i<e.length;i++){var r=e[i];n.push({anchor:h(r.from().line,0),head:h(r.to().line+1,0)})}t.setSelections(n)},u["Shift-Ctrl-K"]="deleteLine",d[u[p+"Enter"]="insertLineAfter"]=function(t){return i(t,!1)},d[u["Shift-"+p+"Enter"]="insertLineBefore"]=function(t){return i(t,!0)},d[u[p+"D"]="selectNextOccurrence"]=function(e){var n=e.getCursor("from"),i=e.getCursor("to"),o=e.state.sublimeFindFullWord==e.doc.sel;if(0==t.cmpPos(n,i)){var s=r(e,n);if(!s.word)return;e.setSelection(s.from,s.to),o=!0}else{var a=e.getRange(n,i),l=o?new RegExp("\\b"+a+"\\b"):a,c=e.getSearchCursor(l,i);c.findNext()?e.addSelection(c.from(),c.to()):(c=e.getSearchCursor(l,h(e.firstLine(),0)),c.findNext()&&e.addSelection(c.from(),c.to()))}o&&(e.state.sublimeFindFullWord=e.doc.sel)};var m="(){}[]";d[u["Shift-"+p+"Space"]="selectScope"]=function(t){o(t)||t.execCommand("selectAll")},d[u["Shift-"+p+"M"]="selectBetweenBrackets"]=function(e){if(!o(e))return t.Pass},d[u[p+"M"]="goToBracket"]=function(e){e.extendSelectionsBy(function(n){var i=e.scanForBracket(n.head,1);if(i&&0!=t.cmpPos(i.pos,n.head))return i.pos;var r=e.scanForBracket(n.head,-1);return r&&h(r.pos.line,r.pos.ch+1)||n.head})};var v=f?"Cmd-Ctrl-":"Shift-Ctrl-";d[u[v+"Up"]="swapLineUp"]=function(e){if(e.isReadOnly())return t.Pass;for(var n=e.listSelections(),i=[],r=e.firstLine()-1,o=[],s=0;s<n.length;s++){var a=n[s],l=a.from().line-1,c=a.to().line;o.push({anchor:h(a.anchor.line-1,a.anchor.ch),head:h(a.head.line-1,a.head.ch)}),0!=a.to().ch||a.empty()||--c,l>r?i.push(l,c):i.length&&(i[i.length-1]=c),r=c}e.operation(function(){for(var t=0;t<i.length;t+=2){var n=i[t],r=i[t+1],s=e.getLine(n);e.replaceRange("",h(n,0),h(n+1,0),"+swapLine"),r>e.lastLine()?e.replaceRange("\n"+s,h(e.lastLine()),null,"+swapLine"):e.replaceRange(s+"\n",h(r,0),null,"+swapLine")}e.setSelections(o),e.scrollIntoView()})},d[u[v+"Down"]="swapLineDown"]=function(e){if(e.isReadOnly())return t.Pass;for(var n=e.listSelections(),i=[],r=e.lastLine()+1,o=n.length-1;o>=0;o--){var s=n[o],a=s.to().line+1,l=s.from().line;0!=s.to().ch||s.empty()||a--,a<r?i.push(a,l):i.length&&(i[i.length-1]=l),r=l}e.operation(function(){for(var t=i.length-2;t>=0;t-=2){var n=i[t],r=i[t+1],o=e.getLine(n);n==e.lastLine()?e.replaceRange("",h(n-1),h(n),"+swapLine"):e.replaceRange("",h(n,0),h(n+1,0),"+swapLine"),e.replaceRange(o+"\n",h(r,0),null,"+swapLine")}e.scrollIntoView()})},d[u[p+"/"]="toggleCommentIndented"]=function(t){t.toggleComment({indent:!0})},d[u[p+"J"]="joinLines"]=function(t){for(var e=t.listSelections(),n=[],i=0;i<e.length;i++){for(var r=e[i],o=r.from(),s=o.line,a=r.to().line;i<e.length-1&&e[i+1].from().line==a;)a=e[++i].to().line;n.push({start:s,end:a,anchor:!r.empty()&&o})}t.operation(function(){for(var e=0,i=[],r=0;r<n.length;r++){for(var o,s=n[r],a=s.anchor&&h(s.anchor.line-e,s.anchor.ch),l=s.start;l<=s.end;l++){var c=l-e;l==s.end&&(o=h(c,t.getLine(c).length+1)),c<t.lastLine()&&(t.replaceRange(" ",h(c),h(c+1,/^\s*/.exec(t.getLine(c+1))[0].length)),++e)}i.push({anchor:a||o,head:o})}t.setSelections(i,0)})},d[u["Shift-"+p+"D"]="duplicateLine"]=function(t){t.operation(function(){for(var e=t.listSelections().length,n=0;n<e;n++){var i=t.listSelections()[n];i.empty()?t.replaceRange(t.getLine(i.head.line)+"\n",h(i.head.line,0)):t.replaceRange(t.getRange(i.from(),i.to()),i.from())}t.scrollIntoView()})},u[p+"T"]="transposeChars",d[u.F9="sortLines"]=function(t){s(t,!0)},d[u[p+"F9"]="sortLinesInsensitive"]=function(t){s(t,!1)},d[u.F2="nextBookmark"]=function(t){var e=t.state.sublimeBookmarks;if(e)for(;e.length;){var n=e.shift(),i=n.find();if(i)return e.push(n),t.setSelection(i.from,i.to)}},d[u["Shift-F2"]="prevBookmark"]=function(t){var e=t.state.sublimeBookmarks;if(e)for(;e.length;){e.unshift(e.pop());var n=e[e.length-1].find();if(n)return t.setSelection(n.from,n.to);e.pop()}},d[u[p+"F2"]="toggleBookmark"]=function(t){for(var e=t.listSelections(),n=t.state.sublimeBookmarks||(t.state.sublimeBookmarks=[]),i=0;i<e.length;i++){for(var r=e[i].from(),o=e[i].to(),s=t.findMarks(r,o),a=0;a<s.length;a++)if(s[a].sublimeBookmark){s[a].clear();for(var l=0;l<n.length;l++)n[l]==s[a]&&n.splice(l--,1);break}a==s.length&&n.push(t.markText(r,o,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},d[u["Shift-"+p+"F2"]="clearBookmarks"]=function(t){var e=t.state.sublimeBookmarks;if(e)for(var n=0;n<e.length;n++)e[n].clear();e.length=0},d[u["Alt-F2"]="selectBookmarks"]=function(t){var e=t.state.sublimeBookmarks,n=[];if(e)for(var i=0;i<e.length;i++){var r=e[i].find();r?n.push({anchor:r.from,head:r.to}):e.splice(i--,0)}n.length&&t.setSelections(n,0)},u["Alt-Q"]="wrapLines";var _=p+"K ";u[_+p+"Backspace"]="delLineLeft",d[u.Backspace="smartBackspace"]=function(e){return e.somethingSelected()?t.Pass:void e.operation(function(){for(var n=e.listSelections(),i=e.getOption("indentUnit"),r=n.length-1;r>=0;r--){var o=n[r].head,s=e.getRange({line:o.line,ch:0},o),a=t.countColumn(s,null,e.getOption("tabSize")),l=e.findPosH(o,-1,"char",!1);if(s&&!/\S/.test(s)&&a%i==0){var c=new h(o.line,t.findColumn(s,a-i,i));c.ch!=o.ch&&(l=c)}e.replaceRange("",l,o,"+delete")}})},d[u[_+p+"K"]="delLineRight"]=function(t){t.operation(function(){for(var e=t.listSelections(),n=e.length-1;n>=0;n--)t.replaceRange("",e[n].anchor,h(e[n].to().line),"+delete");t.scrollIntoView()})},d[u[_+p+"U"]="upcaseAtCursor"]=function(t){a(t,function(t){return t.toUpperCase()})},d[u[_+p+"L"]="downcaseAtCursor"]=function(t){a(t,function(t){return t.toLowerCase()})},d[u[_+p+"Space"]="setSublimeMark"]=function(t){t.state.sublimeMark&&t.state.sublimeMark.clear(),t.state.sublimeMark=t.setBookmark(t.getCursor())},d[u[_+p+"A"]="selectToSublimeMark"]=function(t){var e=t.state.sublimeMark&&t.state.sublimeMark.find();e&&t.setSelection(t.getCursor(),e)},d[u[_+p+"W"]="deleteToSublimeMark"]=function(e){var n=e.state.sublimeMark&&e.state.sublimeMark.find();if(n){var i=e.getCursor(),r=n;if(t.cmpPos(i,r)>0){var o=r;r=i,i=o}e.state.sublimeKilled=e.getRange(i,r),e.replaceRange("",i,r)}},d[u[_+p+"X"]="swapWithSublimeMark"]=function(t){var e=t.state.sublimeMark&&t.state.sublimeMark.find();e&&(t.state.sublimeMark.clear(),t.state.sublimeMark=t.setBookmark(t.getCursor()),t.setCursor(e))},d[u[_+p+"Y"]="sublimeYank"]=function(t){null!=t.state.sublimeKilled&&t.replaceSelection(t.state.sublimeKilled,null,"paste")},u[_+p+"G"]="clearBookmarks",d[u[_+p+"C"]="showInCenter"]=function(t){var e=t.cursorCoords(null,"local");t.scrollTo(null,(e.top+e.bottom)/2-t.getScrollInfo().clientHeight/2)};var y=f?"Ctrl-Shift-":"Ctrl-Alt-";d[u[y+"Up"]="selectLinesUpward"]=function(t){t.operation(function(){for(var e=t.listSelections(),n=0;n<e.length;n++){var i=e[n];i.head.line>t.firstLine()&&t.addSelection(h(i.head.line-1,i.head.ch))}})},d[u[y+"Down"]="selectLinesDownward"]=function(t){t.operation(function(){for(var e=t.listSelections(),n=0;n<e.length;n++){var i=e[n];i.head.line<t.lastLine()&&t.addSelection(h(i.head.line+1,i.head.ch))}})},d[u[p+"F3"]="findUnder"]=function(t){c(t,!0)},d[u["Shift-"+p+"F3"]="findUnderPrevious"]=function(t){c(t,!1)},d[u["Alt-F3"]="findAllUnder"]=function(t){var e=l(t);if(e){for(var n=t.getSearchCursor(e.query),i=[],r=-1;n.findNext();)i.push({anchor:n.from(),head:n.to()}),n.from().line<=e.from.line&&n.from().ch<=e.from.ch&&r++;t.setSelections(i,r)}},u["Shift-"+p+"["]="fold",u["Shift-"+p+"]"]="unfold",u[_+p+"0"]=u[_+p+"j"]="unfoldAll",u[p+"I"]="findIncremental",u["Shift-"+p+"I"]="findIncrementalReverse",u[p+"H"]="replace",u.F3="findNext",u["Shift-F3"]="findPrev",t.normalizeKeyMap(u)});