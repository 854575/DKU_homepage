!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(t){"use strict";function e(t,e,n){var i=t.docs[e];i?n(L(t,i)):t.options.getFile?t.options.getFile(e,n):n(null)}function n(t,e,n){for(var i in t.docs){var r=t.docs[i];if(r.doc==e)return r}if(!n)for(var s=0;;++s)if(i="[doc"+(s||"")+"]",!t.docs[i]){n=i;break}return t.addDoc(n,e)}function i(e,i){return"string"==typeof i?e.docs[i]:(i instanceof t&&(i=i.getDoc()),i instanceof t.Doc?n(e,i):void 0)}function r(t,e,i){var r=n(t,e),o=t.cachedArgHints;o&&o.doc==e&&q(o.start,i.to)>=0&&(t.cachedArgHints=null);var a=r.changed;null==a&&(r.changed=a={from:i.from.line,to:i.from.line});var l=i.from.line+(i.text.length-1);i.from.line<a.to&&(a.to=a.to-(i.to.line-l)),l>=a.to&&(a.to=l+1),a.from>i.from.line&&(a.from=i.from.line),e.lineCount()>F&&i.to-a.from>100&&setTimeout(function(){r.changed&&r.changed.to-r.changed.from>100&&s(t,r)},200)}function s(t,e){t.server.request({files:[{type:"full",name:e.name,text:L(t,e)}]},function(t){t?window.console.error(t):e.changed=null})}function o(e,n,i){e.request(n,{type:"completions",types:!0,docs:!0,urls:!0},function(r,s){if(r)return E(e,n,r);var o=[],l="",c=s.start,u=s.end;'["'==n.getRange(N(c.line,c.ch-2),c)&&'"]'!=n.getRange(u,N(u.line,u.ch+2))&&(l='"]');for(var d=0;d<s.completions.length;++d){var h=s.completions[d],f=a(h.type);s.guess&&(f+=" "+D+"guess"),o.push({text:h.name+l,displayText:h.displayName||h.name,className:f,data:h})}var p={from:c,to:u,list:o},g=null;t.on(p,"close",function(){T(g)}),t.on(p,"update",function(){T(g)}),t.on(p,"select",function(t,n){T(g);var i=e.options.completionTip?e.options.completionTip(t.data):t.data.doc;i&&(g=S(n.parentNode.getBoundingClientRect().right+window.pageXOffset,n.getBoundingClientRect().top+window.pageYOffset,i),g.className+=" "+D+"hint-doc")}),i(p)})}function a(t){var e;return e="?"==t?"unknown":"number"==t||"string"==t||"bool"==t?t:/^fn\(/.test(t)?"fn":/^\[/.test(t)?"array":"object",D+"completion "+D+"completion-"+e}function l(t,e,n,i,r){t.request(e,i,function(n,i){if(n)return E(t,e,n);if(t.options.typeTip)var s=t.options.typeTip(i);else{var s=w("span",null,w("strong",null,i.type||"not found"));if(i.doc&&s.appendChild(document.createTextNode(" \u2014 "+i.doc)),i.url){s.appendChild(document.createTextNode(" "));var o=s.appendChild(w("a",null,"[docs]"));o.href=i.url,o.target="_blank"}}k(e,s,t),r&&r()},n)}function c(e,n){if(M(e),!n.somethingSelected()){var i=n.getTokenAt(n.getCursor()).state,r=t.innerMode(n.getMode(),i);if("javascript"==r.mode.name){var s=r.state.lexical;if("call"==s.info){for(var o,a=s.pos||0,l=n.getOption("tabSize"),c=n.getCursor().line,h=Math.max(0,c-9),f=!1;c>=h;--c){for(var p=n.getLine(c),g=0,m=0;;){var v=p.indexOf("\t",m);if(v==-1)break;g+=l-(v+g)%l-1,m=v+1}if(o=s.column-g,"("==p.charAt(o)){f=!0;break}}if(f){var _=N(c,o),y=e.cachedArgHints;return y&&y.doc==n.getDoc()&&0==q(_,y.start)?u(e,n,a):void e.request(n,{type:"type",preferFunction:!0,end:_},function(t,i){!t&&i.type&&/^fn\(/.test(i.type)&&(e.cachedArgHints={start:_,type:d(i.type),name:i.exprName||i.name||"fn",guess:i.guess,doc:n.getDoc()},u(e,n,a))})}}}}}function u(t,e,n){M(t);for(var i=t.cachedArgHints,r=i.type,s=w("span",i.guess?D+"fhint-guess":null,w("span",D+"fname",i.name),"("),o=0;o<r.args.length;++o){o&&s.appendChild(document.createTextNode(", "));var a=r.args[o];s.appendChild(w("span",D+"farg"+(o==n?" "+D+"farg-current":""),a.name||"?")),"?"!=a.type&&(s.appendChild(document.createTextNode(":\xa0")),s.appendChild(w("span",D+"type",a.type)))}s.appendChild(document.createTextNode(r.rettype?") ->\xa0":")")),r.rettype&&s.appendChild(w("span",D+"type",r.rettype));var l=e.cursorCoords(null,"page");t.activeArgHints=S(l.right+1,l.bottom,s)}function d(t){function e(e){for(var n=0,r=i;;){var s=t.charAt(i);if(e.test(s)&&!n)return t.slice(r,i);/[{\[\(]/.test(s)?++n:/[}\]\)]/.test(s)&&--n,++i}}var n=[],i=3;if(")"!=t.charAt(i))for(;;){var r=t.slice(i).match(/^([^, \(\[\{]+): /);if(r&&(i+=r[0].length,r=r[1]),n.push({name:r,type:e(/[\),]/)}),")"==t.charAt(i))break;i+=2}var s=t.slice(i).match(/^\) -> (.*)$/);return{args:n,rettype:s&&s[1]}}function h(t,e){function i(i){var r={type:"definition",variable:i||null},s=n(t,e.getDoc());t.server.request(b(t,s,r),function(n,i){if(n)return E(t,e,n);if(!i.file&&i.url)return void window.open(i.url);if(i.file){var r,o=t.docs[i.file];if(o&&(r=g(o.doc,i)))return t.jumpStack.push({file:s.name,start:e.getCursor("from"),end:e.getCursor("to")}),void p(t,s,o,r.start,r.end)}E(t,e,"Could not find a definition.")})}m(e)?i():C(e,"Jump to variable",function(t){t&&i(t)})}function f(t,e){var i=t.jumpStack.pop(),r=i&&t.docs[i.file];r&&p(t,n(t,e.getDoc()),r,i.start,i.end)}function p(t,e,n,i,r){n.doc.setSelection(i,r),e!=n&&t.options.switchToDoc&&(M(t),t.options.switchToDoc(n.name,n.doc))}function g(t,e){for(var n=e.context.slice(0,e.contextOffset).split("\n"),i=e.start.line-(n.length-1),r=N(i,(1==n.length?e.start.ch:t.getLine(i).length)-n[0].length),s=t.getLine(i).slice(r.ch),o=i+1;o<t.lineCount()&&s.length<e.context.length;++o)s+="\n"+t.getLine(o);if(s.slice(0,e.context.length)==e.context)return e;for(var a,l=t.getSearchCursor(e.context,0,!1),c=1/0;l.findNext();){var u=l.from(),d=1e4*Math.abs(u.line-r.line);d||(d=Math.abs(u.ch-r.ch)),d<c&&(a=u,c=d)}if(!a)return null;if(1==n.length?a.ch+=n[0].length:a=N(a.line+(n.length-1),n[n.length-1].length),e.start.line==e.end.line)var h=N(a.line,a.ch+(e.end.ch-e.start.ch));else var h=N(a.line+(e.end.line-e.start.line),e.end.ch);return{start:a,end:h}}function m(t){var e=t.getCursor("end"),n=t.getTokenAt(e);return!(n.start<e.ch&&"comment"==n.type)&&/[\w)\]]/.test(t.getLine(e.line).slice(Math.max(e.ch-1,0),e.ch+1))}function v(t,e){var n=e.getTokenAt(e.getCursor());return/\w/.test(n.string)?void C(e,"New name for "+n.string,function(n){t.request(e,{type:"rename",newName:n,fullDocs:!0},function(n,i){return n?E(t,e,n):void y(t,i.changes)})}):E(t,e,"Not at a variable")}function _(t,e){var i=n(t,e.doc).name;t.request(e,{type:"refs"},function(n,r){if(n)return E(t,e,n);for(var s=[],o=0,a=e.getCursor(),l=0;l<r.refs.length;l++){var c=r.refs[l];c.file==i&&(s.push({anchor:c.start,head:c.end}),q(a,c.start)>=0&&q(a,c.end)<=0&&(o=s.length-1))}e.setSelections(s,o)})}function y(t,e){for(var n=Object.create(null),i=0;i<e.length;++i){var r=e[i];(n[r.file]||(n[r.file]=[])).push(r)}for(var s in n){var o=t.docs[s],a=n[s];if(o){a.sort(function(t,e){return q(e.start,t.start)});for(var l="*rename"+ ++H,i=0;i<a.length;++i){var r=a[i];o.doc.replaceRange(r.text,r.start,r.end,l)}}}}function b(t,e,n,i){var r=[],s=0,o=!n.fullDocs;o||delete n.fullDocs,"string"==typeof n&&(n={type:n}),n.lineCharPositions=!0,null==n.end&&(n.end=i||e.doc.getCursor("end"),e.doc.somethingSelected()&&(n.start=e.doc.getCursor("start")));var a=n.start||n.end;if(e.changed)if(e.doc.lineCount()>F&&o!==!1&&e.changed.to-e.changed.from<100&&e.changed.from<=a.line&&e.changed.to>n.end.line){r.push(x(e,a,n.end)),n.file="#0";var s=r[0].offsetLines;null!=n.start&&(n.start=N(n.start.line- -s,n.start.ch)),n.end=N(n.end.line-s,n.end.ch)}else r.push({type:"full",name:e.name,text:L(t,e)}),n.file=e.name,e.changed=null;else n.file=e.name;for(var l in t.docs){var c=t.docs[l];c.changed&&c!=e&&(r.push({type:"full",name:c.name,text:L(t,c)}),c.changed=null)}return{query:n,files:r}}function x(e,n,i){for(var r,s=e.doc,o=null,a=null,l=4,c=n.line-1,u=Math.max(0,c-50);c>=u;--c){var d=s.getLine(c),h=d.search(/\bfunction\b/);if(!(h<0)){var f=t.countColumn(d,null,l);null!=o&&o<=f||(o=f,a=c)}}null==a&&(a=u);var p=Math.min(s.lastLine(),i.line+20);if(null==o||o==t.countColumn(s.getLine(n.line),null,l))r=p;else for(r=i.line+1;r<p;++r){var f=t.countColumn(s.getLine(r),null,l);if(f<=o)break}var g=N(a,0);return{type:"part",name:e.name,offsetLines:g.line,text:s.getRange(g,N(r,0))}}function w(t,e){var n=document.createElement(t);e&&(n.className=e);for(var i=2;i<arguments.length;++i){var r=arguments[i];"string"==typeof r&&(r=document.createTextNode(r)),n.appendChild(r)}return n}function C(t,e,n){t.openDialog?t.openDialog(e+": <input type=text>",n):n(prompt(e,""))}function k(e,n,i){function r(){c=!0,l||s()}function s(){e.state.ternTooltip=null,a.parentNode&&(e.off("cursorActivity",s),e.off("blur",s),e.off("scroll",s),A(a))}e.state.ternTooltip&&T(e.state.ternTooltip);var o=e.cursorCoords(),a=e.state.ternTooltip=S(o.right+1,o.bottom,n),l=!1,c=!1;t.on(a,"mousemove",function(){l=!0}),t.on(a,"mouseout",function(e){t.contains(a,e.relatedTarget||e.toElement)||(c?s():l=!1)}),setTimeout(r,i.options.hintDelay?i.options.hintDelay:1700),e.on("cursorActivity",s),e.on("blur",s),e.on("scroll",s)}function S(t,e,n){var i=w("div",D+"tooltip",n);return i.style.left=t+"px",i.style.top=e+"px",document.body.appendChild(i),i}function T(t){var e=t&&t.parentNode;e&&e.removeChild(t)}function A(t){t.style.opacity="0",setTimeout(function(){T(t)},1100)}function E(t,e,n){t.options.showError?t.options.showError(e,n):k(e,String(n),t)}function M(t){t.activeArgHints&&(T(t.activeArgHints),t.activeArgHints=null)}function L(t,e){var n=e.doc.getValue();return t.options.fileFilter&&(n=t.options.fileFilter(n,e.name,e.doc)),n}function j(t){function n(t,e){e&&(t.id=++r,s[r]=e),i.postMessage(t)}var i=t.worker=new Worker(t.options.workerScript);i.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps});var r=0,s={};i.onmessage=function(i){var r=i.data;"getFile"==r.type?e(t,r.name,function(t,e){n({type:"getFile",err:String(t),text:e,id:r.id})}):"debug"==r.type?window.console.log(r.message):r.id&&s[r.id]&&(s[r.id](r.err,r.body),delete s[r.id])},i.onerror=function(t){for(var e in s)s[e](t);s={}},this.addFile=function(t,e){n({type:"add",name:t,text:e})},this.delFile=function(t){n({type:"del",name:t})},this.request=function(t,e){n({type:"req",body:t},e)}}t.TernServer=function(t){var n=this;this.options=t||{};var i=this.options.plugins||(this.options.plugins={});i.doc_comment||(i.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new j(this):this.server=new tern.Server({getFile:function(t,i){return e(n,t,i)},async:!0,defs:this.options.defs||[],plugins:i}),this.trackChange=function(t,e){r(n,t,e)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(t,e){return o(n,t,e)},this.getHint.async=!0},t.TernServer.prototype={addDoc:function(e,n){var i={doc:n,name:e,changed:null};return this.server.addFile(e,L(this,i)),t.on(n,"change",this.trackChange),this.docs[e]=i},delDoc:function(e){var n=i(this,e);n&&(t.off(n.doc,"change",this.trackChange),delete this.docs[n.name],this.server.delFile(n.name))},hideDoc:function(t){M(this);var e=i(this,t);e&&e.changed&&s(this,e)},complete:function(t){t.showHint({hint:this.getHint})},showType:function(t,e,n){l(this,t,e,"type",n)},showDocs:function(t,e,n){l(this,t,e,"documentation",n)},updateArgHints:function(t){c(this,t)},jumpToDef:function(t){h(this,t)},jumpBack:function(t){f(this,t)},rename:function(t){v(this,t)},selectName:function(t){_(this,t)},request:function(t,e,i,r){var s=this,o=n(this,t.getDoc()),a=b(this,o,e,r),l=a.query&&this.options.queryOptions&&this.options.queryOptions[a.query.type];if(l)for(var c in l)a.query[c]=l[c];this.server.request(a,function(t,n){!t&&s.options.responseFilter&&(n=s.options.responseFilter(o,e,a,t,n)),i(t,n)})},destroy:function(){M(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var N=t.Pos,D="CodeMirror-Tern-",F=250,H=0,q=t.cmpPos});