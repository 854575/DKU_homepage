!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],t):t(CodeMirror)}(function(t){function e(e){if(e.getOption("disableInput"))return t.Pass;for(var n=e.listSelections(),i=[],l=0;l<n.length;l++){if(!n[l].empty())return t.Pass;var c=n[l].head,d=e.getTokenAt(c),u=t.innerMode(e.getMode(),d.state),h=u.state;if("xml"!=u.mode.name||!h.tagName)return t.Pass;var f=e.getOption("autoCloseTags"),p="html"==u.mode.configuration,g="object"==typeof f&&f.dontCloseTags||p&&a,m="object"==typeof f&&f.indentTags||p&&o,v=h.tagName;d.end>c.ch&&(v=v.slice(0,v.length-d.end+c.ch));var _=v.toLowerCase();if(!v||"string"==d.type&&(d.end!=c.ch||!/[\"\']/.test(d.string.charAt(d.string.length-1))||1==d.string.length)||"tag"==d.type&&"closeTag"==h.type||d.string.indexOf("/")==d.string.length-1||g&&s(g,_)>-1||r(e,v,c,h,!0))return t.Pass;var y=m&&s(m,_)>-1;i[l]={indent:y,text:">"+(y?"\n\n":"")+"</"+v+">",newPos:y?t.Pos(c.line+1,0):t.Pos(c.line,c.ch+1)}}for(var l=n.length-1;l>=0;l--){var b=i[l];e.replaceRange(b.text,n[l].head,n[l].anchor,"+insert");var x=e.listSelections().slice(0);x[l]={head:b.newPos,anchor:b.newPos},e.setSelections(x),b.indent&&(e.indentLine(b.newPos.line,null,!0),e.indentLine(b.newPos.line+1,null,!0))}}function n(e,n){for(var i=e.listSelections(),s=[],a=n?"/":"</",o=0;o<i.length;o++){if(!i[o].empty())return t.Pass;var l=i[o].head,c=e.getTokenAt(l),d=t.innerMode(e.getMode(),c.state),u=d.state;if(n&&("string"==c.type||"<"!=c.string.charAt(0)||c.start!=l.ch-1))return t.Pass;var h;if("xml"!=d.mode.name)if("htmlmixed"==e.getMode().name&&"javascript"==d.mode.name)h=a+"script";else{if("htmlmixed"!=e.getMode().name||"css"!=d.mode.name)return t.Pass;h=a+"style"}else{if(!u.context||!u.context.tagName||r(e,u.context.tagName,l,u))return t.Pass;h=a+u.context.tagName}">"!=e.getLine(l.line).charAt(c.end)&&(h+=">"),s[o]=h}e.replaceSelections(s),i=e.listSelections();for(var o=0;o<i.length;o++)(o==i.length-1||i[o].head.line<i[o+1].head.line)&&e.indentLine(i[o].head.line)}function i(e){return e.getOption("disableInput")?t.Pass:n(e,!0)}function s(t,e){if(t.indexOf)return t.indexOf(e);for(var n=0,i=t.length;n<i;++n)if(t[n]==e)return n;return-1}function r(e,n,i,s,r){if(!t.scanForClosingTag)return!1;var a=Math.min(e.lastLine()+1,i.line+500),o=t.scanForClosingTag(e,i,null,a);if(!o||o.tag!=n)return!1;for(var l=s.context,c=r?1:0;l&&l.tagName==n;l=l.prev)++c;i=o.to;for(var d=1;d<c;d++){var u=t.scanForClosingTag(e,i,null,a);if(!u||u.tag!=n)return!1;i=u.to}return!0}t.defineOption("autoCloseTags",!1,function(n,s,r){if(r!=t.Init&&r&&n.removeKeyMap("autoCloseTags"),s){var a={name:"autoCloseTags"};("object"!=typeof s||s.whenClosing)&&(a["'/'"]=function(t){return i(t)}),("object"!=typeof s||s.whenOpening)&&(a["'>'"]=function(t){return e(t)}),n.addKeyMap(a)}});var a=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],o=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];t.commands.closeTag=function(t){return n(t)}});