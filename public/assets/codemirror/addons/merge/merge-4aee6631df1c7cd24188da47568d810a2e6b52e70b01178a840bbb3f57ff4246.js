!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],t):t(CodeMirror)}(function(t){"use strict";function e(t,e){this.mv=t,this.type=e,this.classes="left"==e?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function n(e){e.diffOutOfDate&&(e.diff=x(e.orig.getValue(),e.edit.getValue()),e.chunks=w(e.diff),e.diffOutOfDate=!1,t.signal(e.edit,"updateDiff",e.diff))}function i(t){function e(e){I=!0,h=!1,"full"==e&&(t.svg&&M(t.svg),t.copyButtons&&M(t.copyButtons),l(t.edit,a.marked,t.classes),l(t.orig,u.marked,t.classes),a.from=a.to=u.from=u.to=0),n(t),t.showDifferences&&(c(t.edit,t.diff,a,DIFF_INSERT,t.classes),c(t.orig,t.diff,u,DIFF_DELETE,t.classes)),d(t),"align"==t.mv.options.connect&&p(t),I=!1}function i(e){I||(t.dealigned=!0,r(e))}function r(t){I||h||(clearTimeout(o),t===!0&&(h=!0),o=setTimeout(e,t===!0?20:250))}function s(e,n){t.diffOutOfDate||(t.diffOutOfDate=!0,a.from=a.to=u.from=u.to=0),i(n.text.length-1!=n.to.line-n.from.line)}var o,a={from:0,to:0,marked:[]},u={from:0,to:0,marked:[]},h=!1;return t.edit.on("change",s),t.orig.on("change",s),t.edit.on("markerAdded",i),t.edit.on("markerCleared",i),t.orig.on("markerAdded",i),t.orig.on("markerCleared",i),t.edit.on("viewportChange",function(){r(!1)}),t.orig.on("viewportChange",function(){r(!1)}),e(),e}function r(t){t.edit.on("scroll",function(){s(t,DIFF_INSERT)&&d(t)}),t.orig.on("scroll",function(){s(t,DIFF_DELETE)&&d(t)})}function s(t,e){if(t.diffOutOfDate)return!1;if(!t.lockScroll)return!0;var n,i,r=+new Date;if(e==DIFF_INSERT?(n=t.edit,i=t.orig):(n=t.orig,i=t.edit),n.state.scrollSetBy==t&&(n.state.scrollSetAt||0)+50>r)return!1;var s=n.getScrollInfo();if("align"==t.mv.options.connect)m=s.top;else{var a,l,c=.5*s.clientHeight,u=s.top+c,d=n.lineAtHeight(u,"local"),h=S(t.chunks,d,e==DIFF_INSERT),f=o(n,e==DIFF_INSERT?h.edit:h.orig),p=o(i,e==DIFF_INSERT?h.orig:h.edit),g=(u-f.top)/(f.bot-f.top),m=p.top-c+g*(p.bot-p.top);if(m>s.top&&(l=s.top/c)<1)m=m*l+s.top*(1-l);else if((a=s.height-s.clientHeight-s.top)<c){var v=i.getScrollInfo(),_=v.height-v.clientHeight-m;_>a&&(l=a/c)<1&&(m=m*l+(v.height-v.clientHeight-a)*(1-l))}}return i.scrollTo(s.left,m),i.state.scrollSetAt=r,i.state.scrollSetBy=t,!0}function o(t,e){var n=e.after;return null==n&&(n=t.lastLine()+1),{top:t.heightAtLine(e.before||0,"local"),bot:t.heightAtLine(n,"local")}}function a(t,e,n){t.lockScroll=e,e&&0!=n&&s(t,DIFF_INSERT)&&d(t),t.lockButton.innerHTML=e?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function l(e,n,i){for(var r=0;r<n.length;++r){var s=n[r];s instanceof t.TextMarker?s.clear():s.parent&&(e.removeLineClass(s,"background",i.chunk),e.removeLineClass(s,"background",i.start),e.removeLineClass(s,"background",i.end))}n.length=0}function c(t,e,n,i,r){var s=t.getViewport();t.operation(function(){n.from==n.to||s.from-n.to>20||n.from-s.to>20?(l(t,n.marked,r),u(t,e,i,n.marked,s.from,s.to,r),n.from=s.from,n.to=s.to):(s.from<n.from&&(u(t,e,i,n.marked,s.from,n.from,r),n.from=s.from),s.to>n.to&&(u(t,e,i,n.marked,n.to,s.to,r),n.to=s.to))})}function u(t,e,n,i,r,s,o){function a(e,n){for(var a=Math.max(r,e),l=Math.min(s,n),c=a;c<l;++c){var u=t.addLineClass(c,"background",o.chunk);c==e&&t.addLineClass(u,"background",o.start),c==n-1&&t.addLineClass(u,"background",o.end),i.push(u)}e==n&&a==n&&l==n&&(a?i.push(t.addLineClass(a-1,"background",o.end)):i.push(t.addLineClass(a,"background",o.start)))}for(var l=R(0,0),c=R(r,0),u=t.clipPos(R(s-1)),d=n==DIFF_DELETE?o.del:o.insert,h=0,f=0;f<e.length;++f){var p=e[f],g=p[0],m=p[1];if(g==DIFF_EQUAL){var v=l.line+(k(e,f)?0:1);F(l,m);var _=l.line+(C(e,f)?1:0);_>v&&(f&&a(h,v),h=_)}else if(g==n){var y=F(l,m,!0),b=q(c,l),x=H(u,y);$(b,x)||i.push(t.markText(b,x,{className:d})),l=y}}h<=l.line&&a(h,l.line+1)}function d(t){if(t.showDifferences){if(t.svg){M(t.svg);var e=t.gap.offsetWidth;D(t.svg,"width",e,"height",t.gap.offsetHeight)}t.copyButtons&&M(t.copyButtons);for(var n=t.edit.getViewport(),i=t.orig.getViewport(),r=t.edit.getScrollInfo().top,s=t.orig.getScrollInfo().top,o=0;o<t.chunks.length;o++){var a=t.chunks[o];a.editFrom<=n.to&&a.editTo>=n.from&&a.origFrom<=i.to&&a.origTo>=i.from&&v(t,a,s,r,e)}}}function h(t,e){for(var n=0,i=0,r=0;r<e.length;r++){var s=e[r];if(s.editTo>t&&s.editFrom<=t)return null;if(s.editFrom>t)break;n=s.editTo,i=s.origTo}return i+(t-n)}function f(t,e){for(var n=[],i=0;i<t.chunks.length;i++){var r=t.chunks[i];n.push([r.origTo,r.editTo,e?h(r.editTo,e.chunks):null])}if(e)for(var i=0;i<e.chunks.length;i++){for(var r=e.chunks[i],s=0;s<n.length;s++){var o=n[s];if(o[1]==r.editTo){s=-1;break}if(o[1]>r.editTo)break}s>-1&&n.splice(s-1,0,[h(r.editTo,t.chunks),r.editTo,r.origTo])}return n}function p(t,e){if(t.dealigned||e){if(!t.orig.curOp)return t.orig.operation(function(){p(t,e)});t.dealigned=!1;var i=t.mv.left==t?t.mv.right:t.mv.left;i&&(n(i),i.dealigned=!1);for(var r=f(t,i),s=t.mv.aligners,o=0;o<s.length;o++)s[o].clear();s.length=0;var a=[t.orig,t.edit],l=[];i&&a.push(i.orig);for(var o=0;o<a.length;o++)l.push(a[o].getScrollInfo().top);for(var c=0;c<r.length;c++)g(a,r[c],s);for(var o=0;o<a.length;o++)a[o].scrollTo(null,l[o])}}function g(t,e,n){for(var i=0,r=[],s=0;s<t.length;s++)if(null!=e[s]){var o=t[s].heightAtLine(e[s],"local");r[s]=o,i=Math.max(i,o)}for(var s=0;s<t.length;s++)if(null!=e[s]){var a=i-r[s];a>1&&n.push(m(t[s],e[s],a))}}function m(t,e,n){var i=!0;e>t.lastLine()&&(e--,i=!1);var r=document.createElement("div");return r.className="CodeMirror-merge-spacer",r.style.height=n+"px",r.style.minWidth="1px",t.addLineWidget(e,r,{height:n,above:i})}function v(t,e,n,i,r){var s="left"==t.type,o=t.orig.heightAtLine(e.origFrom,"local")-n;if(t.svg){var a=o,l=t.edit.heightAtLine(e.editFrom,"local")-i;if(s){var c=a;a=l,l=c}var u=t.orig.heightAtLine(e.origTo,"local")-n,d=t.edit.heightAtLine(e.editTo,"local")-i;if(s){var c=u;u=d,d=c}var h=" C "+r/2+" "+l+" "+r/2+" "+a+" "+(r+2)+" "+a,f=" C "+r/2+" "+u+" "+r/2+" "+d+" -1 "+d;D(t.svg.appendChild(document.createElementNS(W,"path")),"d","M -1 "+l+h+" L "+(r+2)+" "+u+f+" z","class",t.classes.connect)}if(t.copyButtons){var p=t.copyButtons.appendChild(j("div","left"==t.type?"\u21dd":"\u21dc","CodeMirror-merge-copy")),g=t.mv.options.allowEditingOriginals;if(p.title=g?"Push to left":"Revert chunk",p.chunk=e,p.style.top=o+"px",g){var m=t.orig.heightAtLine(e.editFrom,"local")-i,v=t.copyButtons.appendChild(j("div","right"==t.type?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));v.title="Push to right",v.chunk={editFrom:e.origFrom,editTo:e.origTo,origFrom:e.editFrom,origTo:e.editTo},v.style.top=m+"px","right"==t.type?v.style.left="2px":v.style.right="2px"}}}function _(t,e,n,i){if(!t.diffOutOfDate){var r=i.editTo>e.lastLine()?R(i.editFrom-1):R(i.editFrom,0),s=i.origTo>n.lastLine()?R(i.origFrom-1):R(i.origFrom,0);e.replaceRange(n.getRange(s,R(i.origTo,0)),r,R(i.editTo,0))}}function y(e){var n=e.lockButton=j("div",null,"CodeMirror-merge-scrolllock");n.title="Toggle locked scrolling";var i=j("div",[n],"CodeMirror-merge-scrolllock-wrap");t.on(n,"click",function(){a(e,!e.lockScroll)});var r=[i];if(e.mv.options.revertButtons!==!1&&(e.copyButtons=j("div",null,"CodeMirror-merge-copybuttons-"+e.type),t.on(e.copyButtons,"click",function(t){var n=t.target||t.srcElement;if(n.chunk)return"CodeMirror-merge-copy-reverse"==n.className?void _(e,e.orig,e.edit,n.chunk):void _(e,e.edit,e.orig,n.chunk)}),r.unshift(e.copyButtons)),"align"!=e.mv.options.connect){var s=document.createElementNS&&document.createElementNS(W,"svg");s&&!s.createSVGRect&&(s=null),e.svg=s,s&&r.push(s)}return e.gap=j("div",r,"CodeMirror-merge-gap")}function b(t){return"string"==typeof t?t:t.getValue()}function x(t,e){var n=U.diff_main(t,e);U.diff_cleanupSemantic(n);for(var i=0;i<n.length;++i){var r=n[i];r[1]?i&&n[i-1][0]==r[0]&&(n.splice(i--,1),n[i][1]+=r[1]):n.splice(i--,1)}return n}function w(t){for(var e=[],n=0,i=0,r=R(0,0),s=R(0,0),o=0;o<t.length;++o){var a=t[o],l=a[0];if(l==DIFF_EQUAL){var c=k(t,o)?0:1,u=r.line+c,d=s.line+c;F(r,a[1],null,s);var h=C(t,o)?1:0,f=r.line+h,p=s.line+h;f>u&&(o&&e.push({origFrom:i,origTo:d,editFrom:n,editTo:u}),n=f,i=p)}else F(l==DIFF_INSERT?r:s,a[1])}return(n<=r.line||i<=s.line)&&e.push({origFrom:i,origTo:s.line+1,editFrom:n,editTo:r.line+1}),e}function C(t,e){if(e==t.length-1)return!0;var n=t[e+1][1];return 1!=n.length&&10==n.charCodeAt(0)&&(e==t.length-2||(n=t[e+2][1],n.length>1&&10==n.charCodeAt(0)))}function k(t,e){if(0==e)return!0;var n=t[e-1][1];return 10==n.charCodeAt(n.length-1)&&(1==e||(n=t[e-2][1],10==n.charCodeAt(n.length-1)))}function S(t,e,n){for(var i,r,s,o,a=0;a<t.length;a++){var l=t[a],c=n?l.editFrom:l.origFrom,u=n?l.editTo:l.origTo;null==r&&(c>e?(r=l.editFrom,o=l.origFrom):u>e&&(r=l.editTo,o=l.origTo)),u<=e?(i=l.editTo,s=l.origTo):c<=e&&(i=l.editFrom,s=l.origFrom)}return{edit:{before:i,after:r},orig:{before:s,after:o}}}function T(e,n,i){function r(){o.clear(),e.removeLineClass(n,"wrap","CodeMirror-merge-collapsed-line")}e.addLineClass(n,"wrap","CodeMirror-merge-collapsed-line");var s=document.createElement("span");s.className="CodeMirror-merge-collapsed-widget",s.title="Identical text collapsed. Click to expand.";var o=e.markText(R(n,0),R(i-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:s,clearOnEnter:!0});return t.on(s,"click",r),{mark:o,clear:r}}function A(t,e){function n(){for(var t=0;t<i.length;t++)i[t].clear()}for(var i=[],r=0;r<e.length;r++){var s=e[r],o=T(s.cm,s.line,s.line+t);i.push(o),o.mark.on("clear",n)}return i[0].mark}function E(t,e,n,i){for(var r=0;r<t.chunks.length;r++)for(var s=t.chunks[r],o=s.editFrom-e;o<s.editTo+e;o++){var a=o+n;a>=0&&a<i.length&&(i[a]=!1)}}function L(t,e){"number"!=typeof e&&(e=2);for(var n=[],i=t.editor(),r=i.firstLine(),s=r,o=i.lastLine();s<=o;s++)n.push(!0);t.left&&E(t.left,e,r,n),t.right&&E(t.right,e,r,n);for(var a=0;a<n.length;a++)if(n[a]){for(var l=a+r,c=1;a<n.length-1&&n[a+1];a++,c++);if(c>e){var u=[{line:l,cm:i}];t.left&&u.push({line:h(l,t.left.chunks),cm:t.left.orig}),t.right&&u.push({line:h(l,t.right.chunks),cm:t.right.orig});var d=A(c,u);t.options.onCollapse&&t.options.onCollapse(t,l,c,d)}}}function j(t,e,n,i){var r=document.createElement(t);if(n&&(r.className=n),i&&(r.style.cssText=i),"string"==typeof e)r.appendChild(document.createTextNode(e));else if(e)for(var s=0;s<e.length;++s)r.appendChild(e[s]);return r}function M(t){for(var e=t.childNodes.length;e>0;--e)t.removeChild(t.firstChild)}function D(t){for(var e=1;e<arguments.length;e+=2)t.setAttribute(arguments[e],arguments[e+1])}function N(t,e){e||(e={});for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function F(t,e,n,i){for(var r=n?R(t.line,t.ch):t,s=0;;){var o=e.indexOf("\n",s);if(o==-1)break;++r.line,i&&++i.line,s=o+1}return r.ch=(s?0:r.ch)+(e.length-s),i&&(i.ch=(s?0:i.ch)+(e.length-s)),r}function H(t,e){return(t.line-e.line||t.ch-e.ch)<0?t:e}function q(t,e){return(t.line-e.line||t.ch-e.ch)>0?t:e}function $(t,e){return t.line==e.line&&t.ch==e.ch}function O(t,e,n){for(var i=t.length-1;i>=0;i--){var r=t[i],s=(n?r.origTo:r.editTo)-1;if(s<e)return s}}function P(t,e,n){for(var i=0;i<t.length;i++){var r=t[i],s=n?r.origFrom:r.editFrom;if(s>e)return s}}function z(e,i){var r=null,s=e.state.diffViews,o=e.getCursor().line;if(s)for(var a=0;a<s.length;a++){var l=s[a],c=e==l.orig;n(l);var u=i<0?O(l.chunks,o,c):P(l.chunks,o,c);null==u||null!=r&&!(i<0?u>r:u<r)||(r=u)}return null==r?t.Pass:void e.setCursor(r,0)}var R=t.Pos,W="http://www.w3.org/2000/svg";e.prototype={constructor:e,init:function(e,n,s){this.edit=this.mv.edit,(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this),this.orig=t(e,N({value:n,readOnly:!this.mv.options.allowEditingOriginals},N(s))),this.orig.state.diffViews=[this],this.diff=x(b(n),b(s.value)),this.chunks=w(this.diff),this.diffOutOfDate=this.dealigned=!1,this.showDifferences=s.showDifferences!==!1,this.forceUpdate=i(this),a(this,!0,!1),r(this)},setShowDifferences:function(t){t=t!==!1,t!=this.showDifferences&&(this.showDifferences=t,this.forceUpdate("full"))}};var I=!1,B=t.MergeView=function(n,i){if(!(this instanceof B))return new B(n,i);this.options=i;var r=i.origLeft,s=null==i.origRight?i.orig:i.origRight,o=null!=r,a=null!=s,l=1+(o?1:0)+(a?1:0),c=[],u=this.left=null,h=this.right=null,f=this;if(o){u=this.left=new e(this,"left");var g=j("div",null,"CodeMirror-merge-pane");c.push(g),c.push(y(u))}var m=j("div",null,"CodeMirror-merge-pane");if(c.push(m),a){h=this.right=new e(this,"right"),c.push(y(h));var v=j("div",null,"CodeMirror-merge-pane");c.push(v)}(a?v:m).className+=" CodeMirror-merge-pane-rightmost",c.push(j("div",null,null,"height: 0; clear: both;"));var _=this.wrap=n.appendChild(j("div",c,"CodeMirror-merge CodeMirror-merge-"+l+"pane"));this.edit=t(m,N(i)),u&&u.init(g,r,i),h&&h.init(v,s,i),i.collapseIdentical&&this.editor().operation(function(){L(f,i.collapseIdentical)}),"align"==i.connect&&(this.aligners=[],p(this.left||this.right,!0));var b=function(){u&&d(u),h&&d(h)};t.on(window,"resize",b);var x=setInterval(function(){for(var e=_.parentNode;e&&e!=document.body;e=e.parentNode);e||(clearInterval(x),t.off(window,"resize",b))},5e3)};B.prototype={constuctor:B,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(t){this.right&&this.right.setShowDifferences(t),this.left&&this.left.setShowDifferences(t)},rightChunks:function(){if(this.right)return n(this.right),this.right.chunks},leftChunks:function(){if(this.left)return n(this.left),this.left.chunks}};var U=new diff_match_patch;t.commands.goNextDiff=function(t){return z(t,1)},t.commands.goPrevDiff=function(t){return z(t,-1)}});